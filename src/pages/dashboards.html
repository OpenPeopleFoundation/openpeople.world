---
layout: layouts/base.njk
title: Dashboards
permalink: /pages/dashboards/
---

<style>
  /* Scoped aesthetics for dashboards page */
  .dash .card{background:#0a0a0a;border:1px solid var(--line);border-radius:16px;padding:18px}
  .dash .stack{display:grid;gap:12px}
  .dash .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .dash .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .dash .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
  .dash .btn-row{display:flex;gap:12px;flex-wrap:wrap}
  .dash .filters{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:end}
  .dash canvas{width:100%!important;height:auto;aspect-ratio:16/9}
  .dash .num{font-size:clamp(20px,4vw,28px);font-weight:800;line-height:1}
  .dash .label{color:var(--muted)}
  .dash .kpi .card{display:grid;align-items:center;min-height:84px}
  @media (max-width: 980px){
    .dash .grid-2,.dash .grid-3,.dash .grid-4{grid-template-columns:1fr}
    .dash .filters{grid-template-columns:1fr}
  }
</style>

<section class="hero dash">
  <div class="container stack">
    <span class="kicker">Cortex</span>
    <h1 class="display">Alignment Dashboards</h1>
    <p class="sub">VR, DE, QAA, FL, CRI — with a Composite Alignment Score (CAS).</p>
  </div>
</section>

<section class="section dash">
  <div class="container stack">
    <!-- Filters -->
    <div class="card filters reveal">
      <div class="stack">
        <label class="stack">
          <span class="sub" style="opacity:.8">Date range</span>
          <select id="range" style="background:#121212;border:1px solid var(--line);border-radius:10px;padding:10px;color:var(--fg)">
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </label>
      </div>
      <div class="btn-row">
        <button id="refresh" class="btn">Refresh</button>
      </div>
    </div>

    <!-- KPI row -->
    <div class="grid-4 kpi">
      <div class="card reveal"><div class="stat"><div class="label">CAS</div><div id="kpi-cas" class="num">–</div></div></div>
      <div class="card reveal"><div class="stat"><div class="label">VR</div><div id="kpi-vr" class="num">–</div></div></div>
      <div class="card reveal"><div class="stat"><div class="label">DE</div><div id="kpi-de" class="num">–</div></div></div>
      <div class="card reveal"><div class="stat"><div class="label">QAA</div><div id="kpi-qaa" class="num">–</div></div></div>
    </div>

    <!-- Charts -->
    <div class="card reveal">
      <h3>Composite Alignment Score (CAS)</h3>
      <canvas id="chart-cas"></canvas>
    </div>

    <div class="grid-2">
      <div class="card reveal">
        <h3>Signals per Metric</h3>
        <canvas id="chart-metrics"></canvas>
      </div>
      <div class="card reveal">
        <h3>Profile (radar)</h3>
        <canvas id="chart-radar"></canvas>
      </div>
    </div>

    <p class="sub" id="dash-msg" style="opacity:.8"></p>
  </div>
</section>

<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // TODO: fill with your project settings
  const SUPABASE_URL  = "https://vwrqapholagchwzkkqpt.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3cnFhcGhvbGFnY2h3emtrcXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjcyMjIsImV4cCI6MjA3NjE0MzIyMn0.cYUNYMx4ebvly0fLWFTtAqWVLEuPmOTZ21wzxEt1_kI";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
  const el = id => document.getElementById(id);
  const msg = el('dash-msg');

  // Auth gate: redirect if not signed in
  async function requireAuth(){
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){
      window.location.href = "/pages/members/";
      return null;
    }
    return user;
  }

  // Fetch metrics: try Supabase; fallback to demo data if table/view absent
  async function fetchMetrics(days){
    // Try the view first (recommended)
    let { data, error } = await supabase
      .from('metrics_30d')
      .select('day, vr, de, qaa, fl, cri, cas')
      .gte('day', new Date(Date.now()- days*864e5).toISOString().slice(0,10));
    if (error || !data) {
      // Try raw table and compute CAS on the client
      let r = await supabase
        .from('metrics_daily')
        .select('day, vr, de, qaa, fl, cri')
        .gte('day', new Date(Date.now()- days*864e5).toISOString().slice(0,10));
      if (r.error || !r.data) {
        // Fallback demo series (no backend yet)
        return demoSeries(days);
      } else {
        return r.data.map(row => ({
          ...row,
          cas: cas(row)
        })).sort((a,b)=> (a.day>b.day?1:-1));
      }
    }
    // Ensure sorted
    return data.sort((a,b)=> (a.day>b.day?1:-1));
  }

  // CAS formula (client)
  function cas({ vr=0, de=0, qaa=0, fl=0, cri=0 }){
    const invFL = (!fl || fl===0) ? 0 : (1/fl);
    return (safe(vr)+safe(de)+safe(qaa)+safe(invFL)+safe(cri)) / 5;
  }
  const safe = v => (typeof v==='number' && isFinite(v)) ? v : 0;

  // Demo generator
  function demoSeries(days){
    const out = [];
    let base = Date.now() - days*864e5;
    for(let i=0;i<days;i++){
      const d = new Date(base + i*864e5).toISOString().slice(0,10);
      const vr = 0.65 + Math.sin(i/5)/10 + rand(.02);
      const de = 0.7  + Math.cos(i/7)/12 + rand(.02);
      const qaa= 0.68 + Math.sin(i/6)/14 + rand(.02);
      const fl = 0.8  + Math.sin(i/8)/16 + rand(.02); // inverse later
      const cri= 0.66 + Math.cos(i/9)/13 + rand(.02);
      out.push({ day:d, vr, de, qaa, fl, cri, cas: cas({vr,de,qaa,fl,cri}) });
    }
    msg.textContent = "Showing demo data (connect Supabase metrics to go live).";
    return out;
  }
  const rand = (a)=> (Math.random()-0.5)*a;

  // Charts
  let chartCAS, chartMetrics, chartRadar;
  function upsertCAS(labels, values){
    chartCAS?.destroy();
    chartCAS = new Chart(el('chart-cas'), {
      type:'line',
      data:{ labels, datasets:[{ label:'CAS', data: values, tension:.25 }]},
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ x:{ grid:{color:'rgba(255,255,255,.08)'}}, y:{ min:0, max:1, grid:{color:'rgba(255,255,255,.08)'}}}
      }
    });
  }
  function upsertMetrics(labels, series){
    chartMetrics?.destroy();
    chartMetrics = new Chart(el('chart-metrics'), {
      type:'bar',
      data:{ labels,
        datasets:[
          {label:'VR', data: series.vr, stack:'m'},
          {label:'DE', data: series.de, stack:'m'},
          {label:'QAA',data: series.qaa,stack:'m'},
          {label:'1/FL',data: series.invfl,stack:'m'},
          {label:'CRI',data: series.cri,stack:'m'}
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ x:{ stacked:true, grid:{color:'rgba(255,255,255,.08)'}},
                 y:{ stacked:true, grid:{color:'rgba(255,255,255,.08)'}}, }
      }
    });
  }
  function upsertRadar(latest){
    chartRadar?.destroy();
    const invfl = (!latest.fl || latest.fl===0) ? 0 : 1/latest.fl;
    chartRadar = new Chart(el('chart-radar'), {
      type:'radar',
      data:{
        labels:['VR','DE','QAA','1/FL','CRI'],
        datasets:[{
          label:'Profile', data:[latest.vr, latest.de, latest.qaa, invfl, latest.cri]
        }]
      },
      options:{ responsive:true, maintainAspectRatio:false,
        scales:{ r:{ min:0, max:1, grid:{color:'rgba(255,255,255,.12)'}, angleLines:{color:'rgba(255,255,255,.12)'} } }
      }
    });
  }

  async function renderDash(days){
    const rows = await fetchMetrics(days);
    if(!rows || rows.length===0){ msg.textContent = "No data yet."; return; }
    // KPIs (last value)
    const last = rows[rows.length-1];
    el('kpi-cas').textContent = last.cas.toFixed(2);
    el('kpi-vr').textContent  = last.vr?.toFixed(2)  ?? '–';
    el('kpi-de').textContent  = last.de?.toFixed(2)  ?? '–';
    el('kpi-qaa').textContent = last.qaa?.toFixed(2) ?? '–';

    const labels = rows.map(r=> r.day.slice(5)); // MM-DD
    upsertCAS(labels, rows.map(r=> r.cas));

    const toSeries = key => rows.map(r=> safe(r[key]));
    upsertMetrics(labels, { vr:toSeries('vr'), de:toSeries('de'), qaa:toSeries('qaa'),
                            invfl: rows.map(r=> (r.fl? 1/r.fl : 0)), cri:toSeries('cri')});
    upsertRadar(last);
  }

  // Wire UI
  el('refresh').addEventListener('click', ()=> renderDash(parseInt(el('range').value, 10)));
  el('range').addEventListener('change', ()=> renderDash(parseInt(el('range').value, 10)));

  // Gate + render
  const user = await requireAuth();
  if (user) renderDash(parseInt(el('range').value, 10));
</script>