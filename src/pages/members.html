---
layout: layouts/base.njk
title: Members
permalink: /pages/members/
---

<style>
  form { display:grid; gap:14px; max-width:520px; }
  input, textarea {
    width:100%;
    background:#121212;
    border:1px solid var(--line);
    color:var(--fg);
    padding:12px 14px;
    border-radius:12px;
  }
  label span { display:block; margin-bottom:4px; color:var(--muted); font-size:15px; }
  .note { color: var(--muted); font-size: 14px; }
</style>
<section class="hero">
  <div class="container grid-2">
    <div class="stack">
      <span class="kicker">Members</span>
      <h1 class="display">Welcome back.</h1>
      <p class="sub">Sign in to access the app and member content.</p>

      <!-- Auth UI -->
      <div id="auth-panel" class="card" style="max-width:480px">
        <div id="signed-out">
          <label class="stack"><span>Email</span>
            <input id="email" type="email" placeholder="you@example.com" />
          </label>
          <button id="magic" class="btn primary">Send Magic Link</button>
          <p class="sub" id="auth-msg" style="opacity:.8"></p>
        </div>

        <div id="signed-in" style="display:none">
          <p class="sub">Youâ€™re signed in as <span id="user-email"></span>.</p>
          <div class="btn-row">
            <button id="view-app" class="btn">View app</button>
            <button id="download-app" class="btn primary">Download app</button>
            <button id="logout" class="btn">Log out</button>
          </div>
          <!-- App embed (optional) -->
          <div id="app-frame" class="card" style="margin-top:16px; display:none;">
            <!-- If your app has a web build, embed it here -->
            <iframe src="/app/index.html" title="Open People App" style="width:100%;aspect-ratio:16/10;border:0;border-radius:12px;"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // TODO: replace with your project values
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_ANON = "YOUR-ANON-PUBLIC-KEY";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const el = (id)=>document.getElementById(id);
  const out = el('signed-out'), inx = el('signed-in'), msg = el('auth-msg');

  async function updateUI() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      out.style.display = 'none';
      inx.style.display = '';
      el('user-email').textContent = user.email;
    } else {
      out.style.display = '';
      inx.style.display = 'none';
    }
  }

  // Magic link
  el('magic').addEventListener('click', async ()=>{
    const email = el('email').value.trim();
    if (!email) { msg.textContent = "Enter an email"; return; }
    const { error } = await supabase.auth.signInWithOtp({ email });
    msg.textContent = error ? ("Error: " + error.message) :
      "Check your email for a magic link.";
  });

  // Logout
  el('logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    await updateUI();
  });

  // View app inline
  el('view-app').addEventListener('click', ()=>{
    el('app-frame').style.display = '';
  });

  // Download app (members only)
  el('download-app').addEventListener('click', async ()=>{
    const sess = await supabase.auth.getSession();
    const token = sess.data.session?.access_token;
    if (!token) { msg.textContent = "Please sign in first."; return; }

    // choose a file key exactly as stored in bucket, e.g. "OpenPeopleApp-mac.dmg"
    const fileKey = "OpenPeopleApp-mac.dmg";

    const res = await fetch("https://YOUR-PROJECT.functions.supabase.co/get-download-url?file="+encodeURIComponent(fileKey), {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) { msg.textContent = "No access. Are you a member?"; return; }
    const { url } = await res.json();
    window.location.href = url; // begin download
  });

  // Watch for auth state changes (after magic link return)
  supabase.auth.onAuthStateChange(async (_event, _session)=>{ updateUI(); });
  updateUI();
</script>